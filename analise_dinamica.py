import requests
import json
import pefile
import os
import hashlib
import csv
import mariadb




try:
    conn = mariadb.connect(
        user="seuuser",
        password="suasenha",
        host="localhost",
        port=3306,
        database="analise_malware"

    )
except mariadb.Error as e:
	print(f"Error connecting to MariaDB Platform: {e}")
	sys.exit(1)



cur = conn.cursor()



dict = dict()

def checkKey(dict, key):    
	if key in dict.keys(): 
		return True
		#print("Key is here, ", end =" ") 
		#print("value =", dict[key])
	else:
		#print("Key isn't present.")
		return False


def validate(filename):

	try:
		with open(filename, encoding="utf-8",errors='ignore') as file:
			try:
				return json.load(file) # put JSON-data to a variable
			except json.decoder.JSONDecodeError:
				print("Invalid JSON") # in case json is invalid
			else:
				print("Valid JSON") # in case json is valid
	except IOError:
		with open(filename, encoding="ISO-8859-1") as file:
			try:
				return json.load(file) # put JSON-data to a variable
			except json.decoder.JSONDecodeError:
				print("Invalid JSON") # in case json is invalid
			else:
				print("Valid JSON") # in case json is valid
			
			



def extract_info(filename):
	#r = validate("D:\scripts\\AnaliseD\\e545bebf9e0380572b0d7440696cc1c4e687e4c100640f1693c223a91e71b9c5.json")
	r = validate(filename)
	dict['info_score'] = r['info']['score']
	dict['info_duration'] = r['info']['duration']
	dict['sha256'] = r['target']['file']['sha256']
	if	'signatures' in r.keys():
		for x in r['signatures']:
			dict[x['name']] = x['markcount']
	
	if	'behavior' in r.keys():
		if 'apistats' in r['behavior'].keys():
			for  x in r['behavior']['apistats']:
				for y in r['behavior']['apistats'][x]:
					exist = checkKey(dict,y)
					if exist:
						dict[y] = dict[y] + r['behavior']['apistats'][x][y]
					else:
						dict[y] = r['behavior']['apistats'][x][y]
				
		for  x in r['behavior']['generic']:
			for y in x:
				if y == "summary":
					for z in x[y]:
						exist = checkKey(dict,z)
						if exist:
							dict[z] = dict[z] + len(x[y][z])
						else:
							dict[z] = len(x[y][z])
							
	
	for x in r['network']:
			dict[x] = len(r['network'][x])
			#print(x,len(r['network'][x]))

	sha256hashed = dict['sha256']
	query_insert_sha256 = "INSERT INTO analises_dinamica (sha256) VALUES ('"+sha256hashed+"')"
	cur.execute(query_insert_sha256)

	for key in dict:
			query_insert_column = 'ALTER TABLE analises_dinamica ADD COLUMN IF NOT EXISTS `'+str(key)+'` TEXT'
			print(query_insert_column)
			cur.execute(query_insert_column)
			query_insert_value= "UPDATE analises_dinamica SET `"+key+"` = '"+str(dict[key])+"' WHERE sha256 = '"+str(sha256hashed)+"'"
			cur.execute(query_insert_value)
			
			
			
	print(len(dict))		
		
		
#extract_info("teste")

count = 0
#list = []	
for file in os.listdir("/home/ubuntu/logs_dinamica/"):
	if file.endswith(".json"):
		print(count)
		count = count + 1
		arquivo = os.path.join("/home/ubuntu/logs_dinamica/", file)
		print(arquivo)
		extract_info(arquivo)


